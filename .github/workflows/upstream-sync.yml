name: Upstream Sync

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure upstream remote
        run: |
          git remote add upstream https://github.com/exa-labs/exa-mcp-server.git || true
          git fetch upstream main

      - name: Check for new upstream changes
        id: check-changes
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/main)
          FORK_MERGE_BASE=$(git merge-base HEAD upstream/main)
          echo "upstream_sha=$UPSTREAM_SHA" >> "$GITHUB_OUTPUT"
          echo "merge_base=$FORK_MERGE_BASE" >> "$GITHUB_OUTPUT"

          if [ "$UPSTREAM_SHA" = "$FORK_MERGE_BASE" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            COMMIT_COUNT=$(git rev-list --count "$FORK_MERGE_BASE".."$UPSTREAM_SHA")
            echo "commit_count=$COMMIT_COUNT" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate diff
        if: steps.check-changes.outputs.has_changes == 'true'
        id: diff
        run: |
          MERGE_BASE=${{ steps.check-changes.outputs.merge_base }}
          UPSTREAM=${{ steps.check-changes.outputs.upstream_sha }}

          git diff "$MERGE_BASE".."$UPSTREAM" > /tmp/upstream.diff

          DIFF_SIZE=$(wc -c < /tmp/upstream.diff)
          if [ "$DIFF_SIZE" -gt 200000 ]; then
            head -c 200000 /tmp/upstream.diff > /tmp/upstream-truncated.diff
            echo "[TRUNCATED: diff was $DIFF_SIZE bytes, showing first 200KB]" >> /tmp/upstream-truncated.diff
            mv /tmp/upstream-truncated.diff /tmp/upstream.diff
          fi

          DIFF_STAT=$(git diff --stat "$MERGE_BASE".."$UPSTREAM")
          echo "diff_stat<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF_STAT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          COMMIT_LOG=$(git log --oneline "$MERGE_BASE".."$UPSTREAM")
          echo "commit_log<<EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMIT_LOG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          CHANGED_FILES=$(git diff --name-only "$MERGE_BASE".."$UPSTREAM")
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Claude security assessment
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: claude-sonnet-4-5-20250929
          prompt: |
            You are reviewing upstream changes from exa-labs/exa-mcp-server before
            they are merged into a private fork.

            ## Context
            - Repository: exa-mcp-server (MCP server for Exa web search API)
            - Upstream commits since last sync: ${{ steps.check-changes.outputs.commit_count }}

            ## Commit log
            ${{ steps.diff.outputs.commit_log }}

            ## Changed files
            ${{ steps.diff.outputs.changed_files }}

            ## Instructions

            1. Read the diff at /tmp/upstream.diff
            2. Run `npm audit` in the repo root and review the output
            3. Analyze everything for:

            ### Security Issues
            - New or changed dependencies (package.json, package-lock.json)
            - Suspicious code patterns (eval, exec, dynamic imports from URLs)
            - Credential or secret exposure
            - Network requests to unexpected endpoints
            - File system access changes
            - Any vulnerabilities reported by npm audit

            ### Supply Chain Risks
            - Modified build scripts, CI workflows, or Dockerfile
            - Dependency tampering (unexpected version changes, new postinstall scripts)
            - Changes to .npmignore or .gitignore
            - New binaries or compiled artifacts

            ### Stability Concerns
            - Breaking API changes (removed exports, changed function signatures)
            - Major refactors that change core behavior
            - Removed or renamed tools/capabilities
            - TypeScript type changes that break compatibility

            4. Write your assessment as JSON to /tmp/verdict.json with this exact schema:
            {
              "verdict": "safe" or "risky",
              "confidence": 0.0 to 1.0,
              "summary": "one-line summary of findings",
              "security_issues": [{"severity": "critical|high|medium|low", "description": "...", "file": "..."}],
              "supply_chain_risks": [{"severity": "critical|high|medium|low", "description": "...", "file": "..."}],
              "stability_concerns": [{"severity": "critical|high|medium|low", "description": "...", "file": "..."}],
              "recommendation": "what the maintainer should do"
            }

            Be conservative: when in doubt, mark as risky. Empty arrays are fine
            when no issues are found in a category.
          claude_args: '--allowedTools "Read,Write,Bash(cat:*),Bash(wc:*),Bash(head:*),Bash(tail:*),Bash(grep:*),Bash(npm audit:*)"'

      - name: Parse assessment
        if: steps.check-changes.outputs.has_changes == 'true'
        id: assessment
        run: |
          if [ ! -f /tmp/verdict.json ]; then
            echo "verdict=error" >> "$GITHUB_OUTPUT"
            echo "summary=Claude did not produce a verdict file" >> "$GITHUB_OUTPUT"
            echo "report=Claude security assessment failed to produce output." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          VERDICT=$(jq -r '.verdict' /tmp/verdict.json)
          CONFIDENCE=$(jq -r '.confidence' /tmp/verdict.json)
          SUMMARY=$(jq -r '.summary' /tmp/verdict.json)
          RECOMMENDATION=$(jq -r '.recommendation' /tmp/verdict.json)

          SECURITY_COUNT=$(jq '.security_issues | length' /tmp/verdict.json)
          SUPPLY_CHAIN_COUNT=$(jq '.supply_chain_risks | length' /tmp/verdict.json)
          STABILITY_COUNT=$(jq '.stability_concerns | length' /tmp/verdict.json)

          echo "verdict=$VERDICT" >> "$GITHUB_OUTPUT"
          echo "confidence=$CONFIDENCE" >> "$GITHUB_OUTPUT"
          echo "summary=$SUMMARY" >> "$GITHUB_OUTPUT"

          {
            echo "report<<EOF"
            echo "## Upstream Sync Security Assessment"
            echo ""
            echo "**Verdict:** $VERDICT (confidence: $CONFIDENCE)"
            echo "**Commits:** ${{ steps.check-changes.outputs.commit_count }}"
            echo ""
            echo "### Summary"
            echo "$SUMMARY"
            echo ""
            if [ "$SECURITY_COUNT" -gt 0 ]; then
              echo "### Security Issues ($SECURITY_COUNT)"
              jq -r '.security_issues[] | "- **\(.severity)**: \(.description)" + if .file then " (\(.file))" else "" end' /tmp/verdict.json
              echo ""
            fi
            if [ "$SUPPLY_CHAIN_COUNT" -gt 0 ]; then
              echo "### Supply Chain Risks ($SUPPLY_CHAIN_COUNT)"
              jq -r '.supply_chain_risks[] | "- **\(.severity)**: \(.description)" + if .file then " (\(.file))" else "" end' /tmp/verdict.json
              echo ""
            fi
            if [ "$STABILITY_COUNT" -gt 0 ]; then
              echo "### Stability Concerns ($STABILITY_COUNT)"
              jq -r '.stability_concerns[] | "- **\(.severity)**: \(.description)" + if .file then " (\(.file))" else "" end' /tmp/verdict.json
              echo ""
            fi
            echo "### Recommendation"
            echo "$RECOMMENDATION"
            echo ""
            echo "### Diff Summary"
            echo '```'
            echo "${{ steps.diff.outputs.diff_stat }}"
            echo '```'
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Attempt merge
        if: steps.check-changes.outputs.has_changes == 'true' && steps.assessment.outputs.verdict == 'safe'
        id: merge
        run: |
          UPSTREAM_SHORT=$(git rev-parse --short upstream/main)
          BRANCH="upstream-sync/$(date +%Y-%m-%d)-${UPSTREAM_SHORT}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"

          if git merge upstream/main --no-edit; then
            echo "merge_success=true" >> "$GITHUB_OUTPUT"
            echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
            git push origin "$BRANCH"
          else
            echo "merge_success=false" >> "$GITHUB_OUTPUT"
            CONFLICTS=$(git diff --name-only --diff-filter=U)
            echo "conflicts<<EOF" >> "$GITHUB_OUTPUT"
            echo "$CONFLICTS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            git merge --abort
          fi

      - name: Create sync PR
        if: steps.merge.outputs.merge_success == 'true'
        id: create-pr
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head "${{ steps.merge.outputs.branch }}" \
            --title "chore: sync with upstream exa-labs/exa-mcp-server" \
            --body "${{ steps.assessment.outputs.report }}")
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Notifications ---

      - name: Notify -- no changes
        if: steps.check-changes.outputs.has_changes == 'false'
        uses: kabilan108/actions/discord-notify@v1
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          level: info
          title: No upstream changes
          description: exa-labs/exa-mcp-server main is already in sync.

      - name: Notify -- PR created
        if: steps.create-pr.outputs.pr_url != ''
        uses: kabilan108/actions/discord-notify@v1
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          level: success
          title: Upstream sync PR created
          description: |
            ${{ steps.check-changes.outputs.commit_count }} commits assessed as safe (confidence: ${{ steps.assessment.outputs.confidence }}).
            PR: ${{ steps.create-pr.outputs.pr_url }}

      - name: Notify -- merge conflicts
        if: steps.merge.outputs.merge_success == 'false'
        uses: kabilan108/actions/discord-notify@v1
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          level: warning
          title: Merge conflicts need manual resolution
          description: |
            ${{ steps.check-changes.outputs.commit_count }} upstream commits assessed as safe, but merge conflicts prevent automatic PR.
            Conflicting files: ${{ steps.merge.outputs.conflicts }}

      - name: Notify -- risky changes
        if: steps.check-changes.outputs.has_changes == 'true' && steps.assessment.outputs.verdict == 'risky'
        uses: kabilan108/actions/discord-notify@v1
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          level: error
          title: Upstream changes flagged as risky
          description: |
            ${{ steps.check-changes.outputs.commit_count }} upstream commits require manual review.
            ${{ steps.assessment.outputs.summary }}

      - name: Notify -- assessment error
        if: steps.check-changes.outputs.has_changes == 'true' && steps.assessment.outputs.verdict == 'error'
        uses: kabilan108/actions/discord-notify@v1
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          level: error
          title: Security assessment failed
          description: Claude did not produce a verdict. Check the workflow run for details.

      - name: Notify -- workflow failure
        if: failure()
        uses: kabilan108/actions/discord-notify@v1
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          level: error
          title: Upstream sync workflow failed
          description: Check the workflow run for details.
